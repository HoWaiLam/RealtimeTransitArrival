function t(){var t=document.createElement("div");return t.id="cesiumContainer",document.body.appendChild(t),t}function i(){return new Cesium.OpenStreetMapImageryProvider({credit:"https://portal.csdi.gov.hk/csdi-webpage/apidoc/ImageryMapAPI",fileExtension:"png",minimumLevel:0,maximumLevel:18,url:"https://mapapi.geodata.gov.hk/gs/api/v1.0.0/xyz/imagery/WGS84"})}function s(){return new Cesium.Terrain(Cesium.CesiumTerrainProvider.fromUrl("data/terrain",{requestVertexNormals:!1}))}function e(){var t=new Cesium.Viewer("cesiumContainer",{animation:!1,baseLayerPicker:!1,baseLayer:new Cesium.ImageryLayer(i()),contextOptions:{allowTextureFilterAnisotropic:!1,webgl:{antialias:!1,premultipliedAlpha:!0}},fullscreenButton:!0,geocoder:!1,homeButton:!1,infoBox:!1,msaaSamples:4,navigationHelpButton:!1,orderIndependentTranslucency:!1,requestRenderMode:!0,resolutionScale:1,scene3DOnly:!0,shadows:!1,shouldAnimate:!0,showFog:!0,terrain:s(),timeline:!1,useBrowserRecommendedResolution:!1,vrButton:!1}),e=t.scene.globe;return e.depthTestAgainstTerrain=!0,e.enableLighting=!0,e.preloadSiblings=!0,e.tileCacheSize=250,t}function n(){return t(),e()}function a(){this.t=void 0,this.i=void 0,this.h=void 0,this.o=void 0,this.u=void 0}a.prototype={get time(){return this.t},set time(t){this.t=t},get interval(){return this.i},set interval(t){this.i=t},get callback(){return this.u},set callback(t){this.u="function"==typeof t?t:function(){}},get started(){return void 0!==this.h}},a.prototype.v=function(){this.m-=this.i,this.m<=0&&(this.u(),this.resetTimer())},a.prototype.initialize=function(t,e,i){this.t=1e3*t,this.m=this.t,this.i=1e3*e,this.u=i},a.prototype.startTimer=function(){let t=this;t.started||(t.h=setInterval(function(){t.v()},t.i))},a.prototype.stopTimer=function(){this.started&&(clearTimeout(this.h),this.h=void 0,this.m=void 0)},a.prototype.resetTimer=function(){this.m=this.t};let o={fillColor:Cesium.Color.BLACK,font:"bold 25px sans-serif",horizontalOrigin:Cesium.HorizontalOrigin.CENTER,position:new Cesium.Cartesian3,style:Cesium.LabelStyle.FILL_AND_OUTLINE,outlineColor:Cesium.Color.WHITE,outlineWidth:3.5,scaleByDistance:new Cesium.NearFarScalar(100,1,5e3,0),show:!0},r=Math.pow(2,32)-1;function h(t,e){var i;return t=t.position?(i=t.position.x-e.container.offsetLeft,t.position.y-e.container.offsetTop):(i=t.endPosition.x-e.container.offsetLeft,t.endPosition.y-e.container.offsetTop),new Cesium.Cartesian2(i,t)}class l{constructor(t){this.i=t,this.t=void 0,this.o=void 0,this.h=void 0,this.l=void 0,this.u=void 0}get show(){return this.o.show}set show(t){this.o.show=t,this.v()}async C(t){this.o=t.primitives.add(await Cesium.Cesium3DTileset.fromUrl(this.i))}m(t){this.h=t.primitives.add(new Cesium.LabelCollection),this.h.add(o)}g(t){let e=this;e.u=new Cesium.ScreenSpaceEventHandler(t.canvas),e.u.setInputAction(function(t){e.select(t)},Cesium.ScreenSpaceEventType.LEFT_CLICK)}v(){this.t.scene.requestRender()}p(){this.o.style=new Cesium.Cesium3DTileStyle({color:"(${buildingid} === "+this.l+")? color('red') : color('white')"})}_(t){var e;this.h.show=!1,void 0!==this.l&&void 0!==t&&((e=this.h.get(0)).text="Building ID\n"+this.l.toString(),Cesium.Cartesian3.fromRadians(t.x,t.y,t.z+5,this.t.scene.globe.ellipsoid,e.position),this.h.show=!0)}B(t){this.l=void 0!==t&&t instanceof Cesium.Cesium3DTileFeature&&t.getProperty?t.getProperty("buildingid"):void 0,this.l=this.l===r?void 0:this.l,this.p(),this._(void 0===this.l?void 0:t.getProperty("labelposition")),this.v()}async load(t){var e=t.scene;await this.C(e),this.m(e),this.g(e),this.t=t}select(t){this.B(this.t.scene.pick(h(t,this.t),10))}}function d(t){var e=new l("data/buildings/tileset_000_000_000.json");return e.load(t),e}let u=Number.MAX_VALUE,z={TWL:"荃灣綫",KTL:"觀塘綫",ISL:"港島綫",SIL:"南港島綫",TKL:"將軍澳綫",TCL:"東涌綫",DRL:"迪士尼綫",AEL:"機場快綫",EAL:"東鐵綫",TML:"屯馬綫"};function h(t,e){var i;return t=t.position?(i=t.position.x-e.container.offsetLeft,t.position.y-e.container.offsetTop):(i=t.endPosition.x-e.container.offsetLeft,t.endPosition.y-e.container.offsetTop),new Cesium.Cartesian2(i,t)}function p(t,e){return null==t?e:t}function c(e){return new Promise(t=>setTimeout(t,e))}function m(s){return new Promise(function(t,e){let i=new Image;i.onload=function(){t(i)},i.onerror=e,i.src=s})}async function g(t){var e;try{e=await fetch(t)}catch(t){}return e?.ok?e.json():{}}function P(t,s){return t.replace(/{([^{}\s]+)}?/g,function(t,e,i){return s[e]})}function f(t,e){return t.eta-e.eta}function v(t,e){return t.priority-e.priority}function C(t){if(null!==t)return t=new Date(t),isNaN(t)?void 0:t}function w(t){return t&&0<t?Math.ceil(t/60):"--"}function R(t){return t.split("-")[0]}function k(t){return null===(t=t.match(/([0-9]+)?\s+mins/))?0:60*Number(t[1])}function U(t,e,i,s){return Math.max(i-(e-t),s)}function y(t){return t===L.Arriving?t:L.None}function W(t,e){return t+e}function j(t){var e="";return t.forEach(function(t){e+=Math.round(10*t)/10+"fr "}),e}function E(t){var e=document.createElement("div");return void 0!==t&&e.classList.add(t),e}function b(t,e){return t.getElementsByClassName(e)[0]}async function T(t,e,i,s,n){if(void 0===(s=await g(s)).data)e.t=void 0;else{var a=s.data;for(let t=0;t<a.length;t++){var o=a[t];null!==o.eta&&""!==o.eta&&e.addEta({co:n,routeNumber:o.route,destEn:o.dest_en,destTc:o.dest_tc,eta:(new Date(o.eta)-i)/1e3})}e.t=p(C(s.generated_timestamp),i)}}async function S(t,e,i,s,n){if(void 0===(s=await g(s)).data)e.t=void 0;else{var a=s.data;for(let t=0;t<a.length;t++){var o=a[t];null!==o.eta&&""!==o.eta&&e.addEta({co:o.co,routeNumber:o.route,destEn:"",destTc:o.dest,eta:(new Date(o.eta)-i)/1e3})}e.t=p(C(s.generated_timestamp),i)}}async function F(s,n,t,e,i){void 0===(e=await g(e)).data?n.t=void 0:(e.data.forEach(function(t){var i,e=s.findRoute(t.route_id.toString()+t.route_seq.toString());void 0!==e&&(i={routeNumber:e.routeNumber,destEn:e.destEn,destTc:e.destTc,eta:u},t.enabled?t.eta.forEach(function(t){var e=Object.assign({},i);e.eta=60*t.diff,n.addEta(e)}):n.addEta(i))}),n.t=p(C(e.generated_timestamp),t))}async function q(s,n,t,e,i){let a=await g(e);void 0===a.data?n.t=void 0:(Object.keys(a.data).forEach(function(t){var i=R(t);void 0!==(t=a.data[t]).UP&&t.UP.forEach(function(t){var e;"Y"===t.valid&&(e=s.findOperatorStop("MTR",t.dest),n.addEta({routeNumber:i,platform:t.plat,destEn:e.nameEn,destTc:e.nameTc,eta:60*Number(t.ttnt)}))}),void 0!==t.DOWN&&t.DOWN.forEach(function(t){var e;"Y"===t.valid&&(e=s.findOperatorStop("MTR",t.dest),n.addEta({routeNumber:i,platform:t.plat,destEn:e.nameEn,destTc:e.nameTc,eta:60*Number(t.ttnt)}))})}),n.t=p(C(a.system_time),t))}async function K(t,i,e,s,n){void 0===(s=await g(s)).platform_list?i.t=void 0:(s.platform_list.forEach(function(e){e.route_list.forEach(function(t){i.addEta({routeNumber:t.route_no,platform:e.platform_id,destEn:t.dest_en,destTc:t.dest_ch,eta:k(t.time_en)})})}),i.t=p(C(s.system_time),e))}let Q={1:{KMB:T,LWB:T,CTB:S,NLB:S},2:{GMB:F},10:{MTR:q},11:{MTR:K}};class G{constructor(t){this.i=t.mode,this.h=t.descEn,this.o=t.descTc,this.u=t.aliasEn,this.l=t.aliasTc,this.p=t.icon,this.v=p(t.hasEta,!1)}get value(){return this.i}get descEn(){return this.h}get descTc(){return this.o}get aliasEn(){return this.u}get aliasTc(){return this.l}get icon(){return this.p}get hasEta(){return this.v}}class X{constructor(){this.m=[]}get count(){return this.m.length}get(t){return this.m[t]}find(e){for(let t=0;t<this.m.length;t++){var i=this.m[t];if(i.value===e)return i}}async load(t){let e=this;await g(t).then(function(t){t.data.forEach(function(t){e.m.push(new G(t))})})}}class ${constructor(){this.g=void 0,this.T=void 0,this.u=void 0,this.l=void 0,this.p=void 0,this._=void 0,this.C=void 0,this.M=void 0}get nameEn(){return this.g}get nameTc(){return this.T}get aliasEn(){return this.u}get aliasTc(){return this.l}get icon(){return this.p}get exitIcon(){return this._}get etaUrl(){return this.C}S(s){return this.C.replace(/{([^{}\s]+)}?/g,function(t,e,i){return s[e]})}initialize(t,e){this.g=e.nameEn,this.T=e.nameTc,this.u=e.aliasEn,this.l=e.aliasTc,this.p=e.icon,this._=e.exitIcon,t.hasEta&&(this.C=e.etaUrl,this.M=Q[t.value][e.aliasEn])}async requestEta(t,e,i,s){await this.M(t,e,i,this.S(s),s.companyCode)}}let L={None:0,Arriving:1,ArrivingSoon:2,NoEta:3};function I(t){return t?t.eta<=60?L.Arriving:L.None:L.NoEta}class V{constructor(t){this.D=t.stopId,this.g=t.nameEn,this.T=t.nameTc,this.L=t.operators,this.N=Cesium.Cartesian3.fromRadians(t.coordinates[0],t.coordinates[1],t.coordinates[2]),this.P=[],this.R=!1,this.V=[],this.t=void 0}get id(){return this.D}get nameEn(){return this.g}get nameTc(){return this.T}get coordinates(){return this.N}get operators(){return this.L}get stops(){return this.k}get exits(){return this.I}get affiliations(){return this.P}get isUpdating(){return this.R}get eta(){return this.V}get etaTimestamp(){return this.t}get state(){return I(this.V[0])}resetEta(){this.V=[]}addEta(e){var i=this.V;for(let t=0;t<i.length;t++){var s=i[t];if(s.routeNumber===e.routeNumber&&s.platform===e.platform)return void(e.eta<s.eta&&(s.eta=s.eta))}i.push(e)}sortEta(){this.V.sort(f)}}class Y{constructor(t){this.D=t.routeId,this.H=t.routeNumber,this.A=t.operators,this.O=t.district,this.J=t.originEn,this.U=t.originTc,this.B=t.destEn,this.j=t.destTc,this.k=t.stops}get id(){return this.D}get routeNumber(){return this.H}get operators(){return this.H}get district(){return this.O}get originEn(){return this.J}get originTc(){return this.U}get destEn(){return this.B}get destTc(){return this.j}get stops(){return this.k}}class N{constructor(t){this.D="transit-m"+t.mode.value,this.W=t.mode,this.L=[],this.K=[],this.k=[],this.I=[],this.$=[],this.q=0,this.G=t,this.Y=void 0,this.F=void 0,this.X=[],this.Z=p(t.update.concurrentUpdate,2),this.tt=0,this.it=p(1e3/t.update.maxNumReuqestsPerSecond*this.Z,100),this.et=p(t.update.minimumWaitTime,0),this.st=t.update.onChange,this.nt=t.update.onDisplayChange,this.rt=!1}get id(){return this.D}get mode(){return this.W}get hasEta(){return this.W.hasEta}get operators(){return this.L}get routes(){return this.K}get stops(){return this.k}get exits(){return this.I}get show(){return this.rt}set show(t){this.rt=t,this.nt.raiseEvent(this)}async ht(){var e=(await g(this.G.data.operators)).data;if(void 0!==e)for(let t=0;t<e.length;t++){var i=new $;i.initialize(this.mode,e[t]),this.L.push(i)}}async ot(){let i=this;await g(i.G.data.routes).then(function(t){var e=t.data;if(void 0!==e)for(let t=0;t<e.length;t++)i.K.push(new Y(e[t]))})}async ut(){let s=this;await g(this.G.data.stops).then(function(t){var e=t.data;if(void 0!==e)for(let t=0;t<e.length;t++){var i=e[t];s.k.push(new V(i))}})}addStopAfflications(){let t=this.K,i=this.k;for(let e=0;e<t.length;e++)t[e].stops.forEach(function(t){i[t].affiliations.push(e)})}async lt(){await Promise.all([this.ht(),this.ot(),this.ut()]),this.addStopAfflications()}ct(){var e=this.k,i=this.Y,s=i.frustum.computeCullingVolume(i.position,i.direction,i.up),n=new Cesium.BoundingSphere,a=this.G.labels.stop.distanceDisplayCondition.far;for(let t=0;t<e.length;t++){var o=e[t];n.center=o.coordinates,s.computeVisibility(n)===Cesium.Intersect.INSIDE&&(o=Cesium.Cartesian3.distanceSquared(i.position,o.coordinates))<=a*a&&this.$.push({priority:o,stop:t})}this.$.sort(v);for(let t=0;t<this.$.length;t++)this.$[t]=this.$[t].stop}dt(t){var e=this.$,i=this.k;this.X=[];for(let t=0;t<e.length;t++){var s=e[t];void 0===i[s].etaTimestamp&&this.X.push(s)}}async ft(t,e){this.k[t].t=e,this.st.raiseEvent(this,t)}async vt(t){let e=this,i=e.X.shift();void 0===i?(--this.tt,this.st.raiseEvent(this)):e.ft(i,t).then(function(){e.vt(t)})}async gt(){var e=new Date;this.ct(),this.dt(e);for(let t=this.tt;t<this.Z;t++)this.tt+=1,this.vt(e)}Tt(){this.$=[],this.q=0}async update(){this.Tt(),this.rt&&this.gt()}async load(t){this.Y=t,await this.lt(),this.rt=!0}findOperator(e){for(let t=0;t<this.L.length;t++){var i=this.L[t];if(i.aliasEn==e)return i}}findRoute(e){for(let t=0;t<this.K.length;t++){var i=this.K[t];if(i.id===e)return i}}findStop(e){for(let t=0;t<this.k.length;t++){var i=this.k[t];if(i.id===e)return i}}findStopIndex(e){for(let t=0;t<this.k.length;t++)if(this.k[t].id===e)return t}findOperatorStop(e,i){var s=this.k;for(let t=0;t<s.length;t++){var n=s[t];if(n.operators[e].includes(i))return n}}hideStop(t){this.wt.hideLabel(t)}showStop(t){this.wt.showLabel(t)}}class Z extends N{constructor(t){super(t),this._t=void 0}bt(){let t=this,e=t.G.update,i=new a;i.initialize(e.updateInterval,e.interval,function(){t.update()}),t._t=i}Ct(){for(let t=this.q=0;t<this.$.length;t++)this.q+=this.k[this.$[t]].state===L.Arriving}dt(e){this.Ct();var i=this.G.update.updateInterval,s=this.k,n=this.$;this.X=[];for(let t=0;t<n.length;t++){var a=s[n[t]];!a.isUpdating&&(void 0===a.etaTimestamp||e-a.etaTimestamp>=1e3*i)&&this.X.push(n[t])}}Et(t){var e=this.K,i=t.affiliations,s=[];for(let t=0;t<i.length;t++){var n=e[i[t]].routeNumber;s.includes(n)||s.push(n)}return s}yt(t,e,i){return t={companyCode:t,stopId:e},void 0!==i&&(t.routeId=i),t}Mt(n,a){let o=this,t=o.Et(n),e=n.operators,r=[];return Object.keys(e).forEach(function(i){var s=o.findOperator(i);void 0!==s&&void 0!==s.etaUrl&&e[i].forEach(function(e){s.etaUrl.includes("{routeId}")?t.forEach(function(t){r.push(s.requestEta(o,n,a,o.yt(i,e,t)))}):r.push(s.requestEta(o,n,a,o.yt(i,e)))})}),r}async ft(t,e){var i=new Date,s=this.k[t],n=y(s.state);s.R=!0,s.resetEta(),await Promise.all(this.Mt(s,e)),s.sortEta(),this.q+=(y(s.state)-n)*this.$.includes(t),s.R=!1,this.st.raiseEvent(this,t),await c(U(i,new Date,this.it,p(this.G.update.minimumWaitTime,0)))}async update(t,e){this.Tt(),this.show&&this.gt(t,e),this._t.resetTimer()}async load(t){this.Y=t,await this.lt(),this.bt(),this.it*=1+.1*(this.L.length-1),this.rt=!0,this.startTimedUpdates()}startTimedUpdates(){void 0===this._t||this._t.started||this._t.startTimer()}stopTimedUpdates(){void 0!==this._t&&this._t.stopTimer()}}class M{constructor(){this.St={}}get count(){return Object.keys(this.St).length}add(t,e){this.St[t]=e}get(t){return this.St[t]}getOperatorHandle(t){return"i-o"+t.aliasEn}getModeHandle(t){return"i-m"+t}getStateHandle(t,e){return`i-m${t}-s`+e}getExitHandle(t){return"i-exit-m"+t}getExitExtenedHandle(t,e){return`i-exit-m${t}-`+e}getTextureHandle(t,e){return t="t-m"+t,void 0!==e&&(t+="-s"+e),t}async zt(t){let e=this,i=e.getOperatorHandle(t);void 0===e.get(i)&&await m("assets\\img\\"+t.icon).then(function(t){e.add(i,t)})}async Dt(t){let e=this,i=(t=p(t.operators,[]),[]);t.forEach(function(t){i.push(e.zt(t))}),await Promise.all(i)}async Lt(t){let e=this,i=t.mode;await m("assets\\img\\"+i.icon).then(function(t){e.add(e.getModeHandle(i.value),t)}),void 0!==i.exitIcon&&await m("assets\\img\\"+i.exitIcon).then(function(t){e.add(e.getExitHandle(i.value),t)})}async Nt(e,i){let s=this;await m("assets\\img\\"+i.icon).then(function(t){s.add(s.getStateHandle(e.value,i.state),t)})}async Pt(t){let e=this,i=t.mode,s=(t=p(t.G.labels.stop.states,[]),[]);t.forEach(function(t){s.push(e.Nt(i,t))}),await Promise.all(s)}async Rt(t){let h=this,e=t.G.labels.stop,l=t.mode,d=h.get(h.getModeHandle(l.value)),u=(t=e.canvasHeight/d.height,Math.floor(d.width*t)),c=Math.floor(d.height*t),i=document.createElement("canvas");i.width=u,i.height=c,i.getContext("2d").drawImage(d,0,0,u,c),h.add(h.getTextureHandle(l.value),i),p(e.states,[]).forEach(function(t){var e,i,s,n,a,o,r=h.get(h.getStateHandle(l.value,t.state));void 0!==r&&(i=t.canvasHeight/r.height,e=Math.floor(r.width*i),i=Math.floor(r.height*i),o=(s=document.createElement("canvas")).getContext("2d"),s.width=Math.floor(u+.5*e),s.height=Math.floor(c+.5*i),n=Math.floor(.5*s.width-.5*u)-1,a=s.height-c-1,(o=s.getContext("2d")).drawImage(d,n,a,u,c),n=Math.floor(s.width-e)-1,o.drawImage(r,n,1,e,i),h.add(h.getTextureHandle(l.value,t.state),s))})}async Vt(t){await Promise.all([this.Dt(t),this.Lt(t),this.Pt(t)]),this.Rt(t)}async initialize(e){var i=[];for(let t=0;t<e.count;t++)i.push(this.Vt(e.get(t)));return Promise.all(i)}}class x{constructor(t,e){this.St=p(e,new M),this.xt=p(t,document.createElement("canvas")),this.kt=this.xt.getContext("2d"),this.It=void 0}Ht(t){var e=window.getComputedStyle(t),i=this.kt;return i.font=e.font,i.measureText(t.innerHTML).width+Number(e.paddingLeft.slice(0,-2))+Number(e.paddingRight.slice(0,-2))}At(t){return t=window.getComputedStyle(t),Number(t.fontSize.slice(0,-2))+Number(t.paddingTop.slice(0,-2))+Number(t.paddingBottom.slice(0,-2))}Ot(t,e){var t=window.getComputedStyle(t),i=this.kt;return i.font=t.font,i.measureText(e).width+Number(t.paddingLeft.slice(0,-2))+Number(t.paddingRight.slice(0,-2))}show(){this.It.classList.remove("exit"),this.It.classList.add("enter")}hide(){this.It.classList.remove("enter"),this.It.classList.add("exit")}}class J{constructor(){this.It=this.Jt(),this.Ut=this.Bt()}Jt(){var t=E("panel-container"),e=(t.id="header-panel-container",E("panel-collection"));return e.id="header-panel-collection",t.appendChild(e),document.body.appendChild(t),e}jt(){var t=document.getElementById("panel-template").content.firstElementChild.cloneNode(!0),e=document.getElementById("header-title-template").content.firstElementChild.cloneNode(!0),i=E("header");i.classList.add("clock"),t.children[0].appendChild(e),t.children[1].appendChild(i),this.It.appendChild(t)}Bt(){let t=this,e=new a;return e.initialize(10,10,function(){t.updateTime()}),e}Wt(){return this.It.getElementsByClassName("header")[1]}updateTime(){var t=new Date,e=t.getHours(),i=t.getFullYear().toString()+"年"+t.getMonth().toString().padStart(2,"0")+"月"+t.getDate().toString().padStart(2,"0")+"日",e=e.toString().padStart(2,"0")+":"+t.getMinutes().toString().padStart(2,"0");this.Wt().innerHTML=i+" "+e}initialize(){this.jt(),this.Ut.startTimer(),this.updateTime()}show(){}hide(){}}class tt extends x{constructor(t,e){super(t,e),this.Kt=void 0,this.It=this.Jt(),this.$t=10}qt(t){return"panel-content-m"+t.mode.value}Jt(){var t=E("panel-container"),e=(t.id="dashboard-panel-container",document.body.appendChild(t),E("panel-collection"));return e.id="dashboard-panel-collection",t.appendChild(e),e}Gt(t,e){var i=t.mode,s=document.getElementById("transit-title-template").content.firstElementChild.cloneNode(!0),n=(e.getElementsByClassName("title")[0].appendChild(s),s.getElementsByClassName("transit-title-tc")[0]),a=s.getElementsByClassName("transit-title-en")[0];n.innerHTML=i.descTc,a.innerHTML=i.descEn,void 0!==(n=this.St.get(this.St.getModeHandle(i.value)))&&(h=(r=s.getElementsByClassName("transit-title-logo")[0]).offsetHeight/n.height,(l=document.createElement("canvas")).width=Math.floor(n.width*h),l.height=Math.floor(n.height*h),l.getContext("2d").drawImage(n,0,0,l.width,l.height),r.appendChild(l));let o=e.getElementsByClassName("transit-title-checkbox")[0].children[0];o.checked=t.show,o.addEventListener("change",function(){t.show=o.checked,t.update()});var r,h,l,a=document.getElementById("transit-content-template").content.firstElementChild.cloneNode(!0);e.getElementsByClassName("contents")[0].appendChild(a),void 0!==(s=this.St.get(this.St.getStateHandle(i.value,L.Arriving)))&&(h=(r=e.getElementsByClassName("transit-tally-img")[0]).offsetHeight/s.height*.65,(l=document.createElement("canvas")).width=Math.floor(s.width*h),l.height=Math.floor(s.height*h),l.getContext("2d").drawImage(s,0,0,l.width,l.height),r.appendChild(l),r.style.margin="auto")}Yt(t,e){return this.Gt(t,e),300}Ft(e){var i=document.getElementById("panel-template"),s=0;for(let t=0;t<e.count;t++){var n=e.get(t),a=i.content.firstElementChild.cloneNode(!0);a.id=this.qt(n),this.It.appendChild(a),s=Math.max(s,this.Yt(n,a))}return s}initialize(t,e){this.Kt=t,this.Ft(e)}find(e){var i=this.It.children;for(let t=0;t<i.length;t++){var s=i[t];if(s.id===e)return s}}pause(){var e=this.It.children;for(let t=0;t<e.length;t++){var i=e[t].getElementsByClassName("transit-tally-value");i[0].innerHTML="--",i[1].innerHTML="--"}}update(t){var e=this.find(this.qt(t)).getElementsByClassName("transit-tally-value");e[0].innerHTML=t.show&&t.hasEta?t.q:"--",e[1].innerHTML=t.show?t.$.length:"--"}resize(){this.Kt&&(this.It.style.height=Math.max(this.Kt.container.offsetHeight-this.It.parentNode.offsetTop,0)+"px")}}class et extends x{constructor(t,e){super(t,e),this.Qt=void 0,this.Xt=void 0,this.Zt=void 0,this.It=this.ti(),this.ii=void 0,this.ei=void 0}ti(){var t=document.getElementById("dashboard-panel-container"),e=E("panel-collection");e.id="popup-panel-collection",e.style.position="absolute",e.style.left="0px",e.style.top="0px",e.classList.add("exit"),t.appendChild(e);(t=document.getElementById("panel-template").content.firstElementChild.cloneNode(!0)).id="popup-panel",e.appendChild(t);var i=document.getElementById("popup-title-template").content.firstElementChild.cloneNode(!0);return i.id="popup-title",t.children[0].appendChild(i),e}si(){var t=(n=document.getElementById("popup-title")).getElementsByClassName("popup-title-tc")[0],e=n.getElementsByClassName("popup-title-en")[0],i=(t.innerHTML=this.Xt.nameTc,e.innerHTML=this.Xt.nameEn.toUpperCase(),this.St.get(this.St.getModeHandle(this.Qt.mode.value))),s=(n=n.getElementsByClassName("popup-title-logo")[0]).firstElementChild,n=(null===s&&(s=document.createElement("canvas"),n.appendChild(s)),(this.At(t)+this.At(e))/i.height);s.width=i.width*n,s.height=i.height*n,s.getContext("2d"),s.getContext("2d").drawImage(i,0,0,s.width,s.height)}addContentRecords(e,i){var s=document.getElementById("popup-content-template");for(let t=0;t<i;t++){var n=s.content.firstElementChild.cloneNode(!0);e.appendChild(n)}}ai(e,i){var s=e.children;for(let t=0;t<i;t++)e.removeChild(s[s.length-1])}ni(t,e){var e=this.St.get(this.St.getOperatorHandle(this.Qt.findOperator(e.co))),i=Math.min(.9*t.height/e.height,.9*t.width/e.width),s=e.width*i,i=e.height*i;t.getContext("2d").drawImage(e,.5*t.width-.5*s,.5*(t.height-i),s,i)}ri(t,e){var i=t.getContext("2d"),s=(void 0!==(s=this.Qt?.G?.labels?.stop?.platforms?.color)&&(n=.9,i.fillStyle=p(s[e.routeNumber],s),i.beginPath(),i.arc(.5*t.width,.5*t.height,t.height*n*.5,0,2*Math.PI,!0),i.fill()),this.Qt?.G?.labels?.stop?.platforms?.text),n=.65;i.font=`bold ${t.height*n}px Arial, san-serif`,i.fillStyle=p(p(s[e.routeNumber.slice(0,-1)],s),"white");s=(n=i.measureText(e.platform)).actualBoundingBoxAscent-n.actualBoundingBoxDescent;i.fillText(e.platform,.5*t.width-.5*n.width,s+.5*(t.height-s))}hi(t,e){var i=(t=b(t,"popup-content-img")).firstElementChild;null==i&&((i=document.createElement("canvas")).width=t.offsetWidth,i.height=t.offsetHeight,t.appendChild(i),t.style.height=i.height+"px",t.style.marginBottom="auto",t.style.marginTop="auto"),i.getContext("2d").clearRect(0,0,i.width,i.height),void 0!==e?.co?this.ni(i,e):void 0!==e?.platform&&this.ri(i,e)}oi(t,e){var i,s,n=(t=b(t,"popup-content-state")).firstElementChild;null==n&&((n=document.createElement("canvas")).width=t.offsetWidth,n.height=t.offsetHeight,t.appendChild(n),t.style.height=n.height+"px",t.style.marginBottom="auto",t.style.marginTop="auto"),(t=n.getContext("2d")).clearRect(0,0,n.width,n.height),(e=I(e))!==L.Arriving&&e!==L.NoEta||(e=this.St.get(this.St.getStateHandle(this.Qt.mode.value,e)),s=Math.min(.9*n.height/e.height,.9*n.width/e.width),i=e.width*s,s=e.height*s,t.drawImage(e,.5*n.width-.5*i,.5*(n.height-s),i,s))}ui(){var e=this.Xt.eta,i=Math.max(e.length,1),s=document.getElementById("popup-panel").children[1],t=i-s.children.length;0<=t?this.addContentRecords(s,t):this.ai(s,Math.abs(t));for(let t=0;t<i;t++){var n=e[t],a=s.children[t];this.hi(a,n),this.oi(a,n),b(a,"popup-content-route").innerHTML=n?n.routeNumber:"",b(a,"popup-content-destc").innerHTML=n?n.destTc:"沒有即時到站資訊",b(a,"popup-content-deste").innerHTML=n?void 0===n.destEn||n.destEn===n.destTc||null===n.destEn?"":n.destEn:"No Real-Time Arrival Information",b(a,"popup-content-eta").innerHTML=w(n?.eta)}}li(){this.si(),this.ui()}gt(){void 0!==this.Zt&&this.Zt==this.Xt.etaTimestamp||(this.li(),this.Zt=this.Xt.etaTimestamp)}update(t,e){t=t.stops[e],this.Xt===t&&this.gt()}forceUpdate(t,e){e=t.stops[e],this.Xt!==e&&(this.Qt=t,this.Xt=e,this.Zt=void 0),this.gt()}}class it{constructor(t,e,i){this.ci=e,this.Qt=t,this.St=i,this.di=void 0,this.pi=void 0,this.fi()}get mode(){return this.Qt.mode}get show(){return this.di.show}set show(t){this.di.show=t,this.pi.show=t,this.ci.requestRender()}vi(){this.di=this.ci.primitives.add(new Cesium.BillboardCollection),this.di.id=this.Qt.id,this.di.show=!1}mi(){this.pi=this.ci.primitives.add(new Cesium.PolylineCollection),this.pi.id=this.Qt.id,this.pi.show=!1}gi(){let t=this.Qt,e=t.G.labels.stop,i=this.di,s=this.pi,n=new Cesium.Cartesian3;t.stops.forEach(function(t){i.add({id:i.length,distanceDisplayCondition:e.distanceDisplayCondition,show:!1,sizeInMeters:e.billboardSizeInMeters}),s.add({id:s.length,distanceDisplayCondition:e.leaderDistanceDisplayCondition,positions:[n,n],material:e.leaderMaterial,show:!1,width:e.leaderWidth})})}Ti(){}fi(){this.vi(),this.mi(),this.gi(),this.Ti()}wi(e){var i=p(this.Qt.G.labels.stop.states,[]);for(let t=0;t<i.length;t++){var s=i[t];if(s.state===e)return p(s.billboardScale,1)}return 1}clear(){this.ci.primitives.remove(this.di),this.ci.primitives.remove(this.pi),this.di.removeAll(),this.pi.removeAll()}updateLabel(t){var e,i,s,n,a,o=this.Qt.mode,r=this.Qt.stops[t],h=this.St,l=h.getTextureHandle(o.value,r.state),d=this.di.get(t);d.image!==l&&(i=(e=this.ci).globe.ellipsoid,s=Cesium.Cartographic.fromCartesian(r.coordinates,i),n=this.Qt.G.labels.stop,r=this.wi(r.state),a=n.billboardHeight/n.canvasHeight*r,h=p(h.get(l),h.get(h.getTextureHandle(o.value))),d.setImage(l,h),d.width=h.width*a,d.height=h.height*a,s.height=Math.max(s.height+n.billboardOffset*r,n.billboardMinimumOffset)+.5*d.height,d.position=Cesium.Cartesian3.fromRadians(s.longitude,s.latitude,s.height,i),d.show=!0,(o=this.pi.get(t)).positions=[Cesium.Cartesian3.fromRadians(s.longitude,s.latitude,s.height,i),Cesium.Cartesian3.fromRadians(s.longitude,s.latitude,0,i)],o.width=n.leaderWidth*Math.min(r,2),o.show=!0,e.requestRender())}highlightLabel(t){(t=this.di.get(t)).scale=1.5,t.color=Cesium.Color.AQUA,this.ci.requestRender()}unHighlightLabel(t){(t=this.di.get(t)).scale=1,t.color=Cesium.Color.WHITE,this.ci.requestRender()}}class st{constructor(t){this.St=p(t,{}),this.wt=[]}initialize(e,i){for(let t=0;t<e.count;t++){var s=e.get(t);this.wt.push(new it(s,i,this.St))}}find(e){for(let t=0;t<this.wt.length;t++){var i=this.wt[t];if(i.mode.value===e.value)return i}}update(t,e){void 0!==(t=this.find(t.mode))&&t.updateLabel(e)}highlight(t,e){t&&void 0!==(t=this.find(t.mode))&&t.highlightLabel(e)}unHighlight(t,e){t&&void 0!==(t=this.find(t.mode))&&t.unHighlightLabel(e)}show(){this.wt.forEach(function(t){t.show=t.Qt.show})}}class nt{constructor(){this.xt=document.createElement("canvas"),this.St=new M,this._i=new J,this.bi=new tt(this.xt,this.St),this.F=new et(this.xt,this.St),this.wt=new st(this.St)}Ci(){var t=this.F.Qt,e=this.F.Xt;this.wt.highlight(t,t?.findStopIndex(e?.id))}Ei(){var t=this.F.Qt,e=this.F.Xt;this.wt.unHighlight(t,t?.findStopIndex(e?.id))}async initialize(t,e){await this.St.initialize(t),this._i.initialize(),this.bi.initialize(e,t),this.wt.initialize(t,e.scene)}show(){this._i.show(),this.bi.show(),this.wt.show()}pauseDashboard(){this.bi.pause()}update(t,e){this.bi.update(t),void 0!==e&&(this.F.update(t,e),this.wt.update(t,e))}updateTransitDisplay(t){this.bi.update(t),this.wt.find(t.mode).show=t.show}updatePopup(t,e){this.Ei(),this.F.forceUpdate(t,e)}showPopup(){this.bi.hide(),this.F.show(),this.Ci()}hidePopup(){this.F.hide(),this.bi.show(),this.Ei()}resize(){this.bi.resize()}}class at{constructor(){this.m=new X,this.yi=[],this.Kt=void 0,this.Mi=new nt,this.st=new Cesium.Event,this.st.addEventListener(this.Mi.update,this.Mi),this.nt=new Cesium.Event,this.nt.addEventListener(this.Mi.updateTransitDisplay,this.Mi),this.Si=void 0}get count(){return this.yi.length}zi(e){this.yi;for(let t=0;t<this.yi.length;t++){var i=this.yi[t];if(i.id===e)return i}}Di(t){let e=this,i=new Cesium.ScreenSpaceEventHandler(t.scene.canvas);i.setInputAction(function(t){e.showPopup(t)},Cesium.ScreenSpaceEventType.MOUSE_MOVE),t.scene.camera.moveEnd.addEventListener(e.update,e),this.Li=i}get(t){return this.yi[t]}find(e){var i=this.yi;for(let t=0;t<i.length;t++){var s=i[t];if(s.mode.mode===e)return s}}async initialize(t){await this.m.load(t)}add(t){if(void 0===this.find(t.mode)){var e=this.m.find(t.mode);if(void 0!==e)return(t=Object.assign({},t)).mode=e,t.update.onChange=this.st,t.update.onDisplayChange=this.nt,e=new(e.hasEta?Z:N)(t),this.yi.push(e),!0}return!1}async Ni(t){await this.Mi.initialize(this,t)}Pi(t){let e=this;e.Si=new Cesium.ScreenSpaceEventHandler(t.canvas),e.Si.setInputAction(function(t){e.showPopup(t)},Cesium.ScreenSpaceEventType.MOUSE_MOVE),t.camera.moveEnd.addEventListener(e.update,e),document.addEventListener("selectstart",function(t){return t.preventDefault(),!1})}async load(e){let t=this,i=[];t.yi.forEach(function(t){i.push(t.load(e.scene.camera))}),await Promise.all(i),await t.Ni(e),t.Pi(e.scene),t.Mi.show(),t.Kt=e}update(){this.yi.forEach(function(t){t.update()})}showPopup(t){void 0!==(t=this.Kt.scene.pick(h(t,this.Kt),10))&&t.collection instanceof Cesium.BillboardCollection?(this.Mi.updatePopup(this.zi(t.collection.id),t.id),this.Mi.showPopup()):this.Mi.hidePopup()}resize(){this.Mi.resize()}}function H(t,e,i,s){var n=Cesium.Material.fromType("Color");return n.uniforms.color=new Cesium.Color(t,e,i,s),n}let D=new Cesium.DistanceDisplayCondition(0,5e3),_=new Cesium.DistanceDisplayCondition(0,5e3),B=new Cesium.NearFarScalar(5e3,1,8500,0),ot=[{mode:10,data:{operators:"data/mtr_operators.json",routes:"data/mtr_routes.json",stops:"data/mtr_stops.json"},labels:{stop:{canvasHeight:100,distanceDisplayCondition:D,translucencyByDistance:B,billboardHeight:12.5,billboardOffset:37.5,billboardMinimumOffset:47.5,billboardSizeInMeters:!0,leaderMaterial:H(.675,.1725,.267,1),leaderWidth:2,leaderDistanceDisplayCondition:_,states:[{state:L.Arriving,icon:"yellowArriving.png",canvasHeight:100,billboardScale:1},{state:L.NoEta,icon:"no-clock-icon.png",canvasHeight:50,billboardScale:1}],platforms:{color:{AEL:"#00888e",DRL:"#eb6ea5",EAL:"#5eb7e8",ISL:"#0075c2",KTL:"#00a040",SIL:"#cbd300",TCL:"#f3982d",TKL:"#7e3c93",TML:"#9c2e00",TWL:"#e60012"},text:"#ffffff"}}},update:{updateInterval:30,interval:15,concurrentUpdate:2,maxNumReuqestsPerSecond:8}},{mode:11,data:{operators:"data/lrt_operators.json",routes:"data/lrt_routes.json",stops:"data/lrt_stops.json"},labels:{stop:{canvasHeight:100,distanceDisplayCondition:D,translucencyByDistance:B,billboardHeight:8,billboardOffset:27.5,billboardMinimumOffset:35,billboardSizeInMeters:!0,leaderMaterial:H(.157,.169,.329,1),leaderWidth:2,leaderDistanceDisplayCondition:_,states:[{state:L.Arriving,icon:"yellowArriving.png",canvasHeight:100,billboardScale:1},{state:L.NoEta,icon:"no-clock-icon.png",canvasHeight:50,billboardScale:1}],platforms:{color:"#cd9700",text:"#002b55"}}},update:{updateInterval:30,interval:15,concurrentUpdate:2,maxNumReuqestsPerSecond:10}},{mode:4,data:{operators:"data/tram_operators.json",routes:"data/tram_routes.json",stops:"data/tram_stops.json"},labels:{stop:{canvasHeight:100,distanceDisplayCondition:D,translucencyByDistance:B,billboardHeight:7.5,billboardOffset:27.5,billboardMinimumOffset:35,billboardSizeInMeters:!0,leaderMaterial:H(0,.6,0,.85),leaderDistanceDisplayCondition:_,leaderWidth:2,states:[{state:L.Arriving,icon:"yellowArriving.png",canvasHeight:100,billboardScale:1},{state:L.NoEta,icon:"no-clock-icon.png",canvasHeight:50,billboardScale:1}]}},update:{updateInterval:30,interval:15,concurrentUpdate:2,maxNumReuqestsPerSecond:10}},{mode:1,data:{operators:"data/bus_operators.json",routes:"data/bus_routes.json",stops:"data/bus_stops.json"},labels:{stop:{canvasHeight:100,distanceDisplayCondition:D,translucencyByDistance:B,billboardHeight:5,billboardOffset:17.5,billboardMinimumOffset:27.5,billboardSizeInMeters:!0,leaderMaterial:H(.016,.424,.737,1),leaderWidth:2,leaderDistanceDisplayCondition:_,states:[{state:L.Arriving,icon:"yellowArriving.png",canvasHeight:100,billboardScale:1},{state:L.NoEta,icon:"no-clock-icon.png",canvasHeight:50,billboardScale:1}]}},update:{updateInterval:30,interval:15,concurrentUpdate:10,maxNumReuqestsPerSecond:50}},{mode:2,data:{operators:"data/minibus_operators.json",routes:"data/minibus_routes.json",stops:"data/minibus_stops.json"},labels:{stop:{distanceDisplayCondition:D,translucencyByDistance:B,canvasHeight:100,billboardHeight:5,billboardOffset:7.5,billboardMinimumOffset:20,billboardSizeInMeters:!0,leaderMaterial:H(.16,.52,.33,1),leaderWidth:2,leaderDistanceDisplayCondition:_,states:[{state:L.Arriving,icon:"yellowArriving.png",canvasHeight:100,billboardScale:1},{state:L.NoEta,icon:"no-clock-icon.png",canvasHeight:50,billboardScale:1}]}},update:{updateInterval:30,interval:15,concurrentUpdate:2,maxNumReuqestsPerSecond:8}}],rt="data/geo_place_names.json",ht=[200,100,25,-5],lt=[{fillColor:Cesium.Color.BLACK,font:"italic bold 40px sans-serif",horizontalOrigin:Cesium.HorizontalOrigin.CENTER,style:Cesium.LabelStyle.FILL_AND_OUTLINE,outlineColor:Cesium.Color.WHITE,outlineWidth:5,scaleByDistance:new Cesium.NearFarScalar(100,1,5e4,0),show:!1},{fillColor:Cesium.Color.BLACK,font:"italic bold 30px sans-serif",horizontalOrigin:Cesium.HorizontalOrigin.CENTER,style:Cesium.LabelStyle.FILL_AND_OUTLINE,outlineColor:Cesium.Color.WHITE,outlineWidth:5,scaleByDistance:new Cesium.NearFarScalar(100,1,15e3,0),show:!0},{fillColor:Cesium.Color.BLACK,font:"italic bold 25px sans-serif",horizontalOrigin:Cesium.HorizontalOrigin.CENTER,style:Cesium.LabelStyle.FILL_AND_OUTLINE,outlineColor:Cesium.Color.WHITE,outlineWidth:5,scaleByDistance:new Cesium.NearFarScalar(100,1,7500,0),show:!0},{fillColor:Cesium.Color.BLACK,font:"italic bold 15px sans-serif",horizontalOrigin:Cesium.HorizontalOrigin.CENTER,style:Cesium.LabelStyle.FILL_AND_OUTLINE,outlineColor:Cesium.Color.WHITE,outlineWidth:5,scaleByDistance:new Cesium.NearFarScalar(100,1,5e3,0),show:!0}];async function dt(){return(await fetch(rt)).json()}async function ut(t){var e=await dt();let i=new Cesium.LabelCollection,s=t.scene.globe.ellipsoid;return e.geo_place_names.forEach(function(t){var e=Object.assign({},lt[t.label_class]);e.text=t.name_tc+"\n"+t.name_en,e.position=Cesium.Cartesian3.fromRadians(t.location[0],t.location[1],t.location[2]+ht[t.label_class],s),i.add(e)}),t.scene.primitives.add(i)}let ct={home:{destination:new Cesium.Cartesian3(-2464666.4109593323,5490246.453413948,2453632.723516274),orientation:{up:new Cesium.Cartesian3(.155509860903652,-.34641096194630594,.9251033069907176),direction:new Cesium.Cartesian3(.37886965735131983,-.8439632168191071,-.3797155137663435)}},tsimShaTsui:{destination:new Cesium.Cartesian3(-2418871.278609269,5388994.320799538,2403099.910086662),orientation:{up:new Cesium.Cartesian3(-.2156087483376233,.5184432857330142,.8274837926622126),direction:new Cesium.Cartesian3(.36024419991759726,-.7454073635302993,.5608849960736499)}},tuenMun:{destination:new Cesium.Cartesian3(-2393599.1613763347,5398701.286732461,2412295.261305741),orientation:{up:new Cesium.Cartesian3(-.5983412773362288,.5239230993606508,.6062114332408949),direction:new Cesium.Cartesian3(-.36868533808067444,-.8517652208130086,.3722460612252403)}}};function pt(t){let e=new at;return e.initialize("data/transit_modes.json").then(function(){ot.forEach(function(t){e.add(t)}),e.load}).then(async function(){await e.load(t)}),e}function mt(t){var e=ct.tsimShaTsui;t.scene.camera.flyTo({destination:e.destination,orientation:e.orientation})}var A,gt,ft,O;window.onload=function(){A=n(),gt=d(A),ft=ut(A),O=pt(A),mt(A)},window.onresize=function(){O?.resize()};